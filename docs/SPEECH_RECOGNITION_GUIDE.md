# 语音识别工具使用指南

## 🎯 功能概述

AI 助手现在支持语音识别功能，可以转录用户提供的音频文件 URL。使用 Paraformer-V2 模型进行高精度语音识别，支持中英文混合识别。

## 🚀 使用方法

### 1. 基本用法
直接在聊天中输入包含音频 URL 的消息：

```
请转录这个音频文件：https://example.com/audio.wav
```

或者：

```
帮我识别这个语音文件的内容：https://example.com/audio.mp3
```

### 2. 支持的音频格式
- WAV
- MP3
- M4A
- FLAC
- 其他常见音频格式

### 3. URL 要求
- 音频文件必须可以通过公网访问
- 建议使用 HTTPS 链接
- 文件大小建议不超过 100MB

## 🎤 工具调用流程

### 用户视角
1. **发送消息**: 用户输入包含音频 URL 的消息
2. **工具调用**: AI 助手自动识别需要调用语音识别工具
3. **处理状态**: 聊天界面显示"正在转录音频..."提示
4. **返回结果**: AI 助手返回格式化的转录结果

### 技术流程
1. **LLM 判断**: Qwen3-plus 模型分析用户消息，判断是否需要调用工具
2. **工具调用**: 自动调用 `speech_recognition` 工具
3. **API 处理**: 调用 Paraformer-V2 API 进行转录
4. **结果处理**: 提取 sentences 字段，格式化输出
5. **用户展示**: AI 助手将转录结果以友好格式展示给用户

## 📊 输出格式

### 工具返回的 JSON 格式
```json
[
  {
    "sentence_id": 0,
    "text": "你好，欢迎使用语音识别功能",
    "begin_time": 0,
    "end_time": 2500
  },
  {
    "sentence_id": 1,
    "text": "这是一个测试音频",
    "begin_time": 2500,
    "end_time": 4000
  }
]
```

### 用户看到的格式
```
句子 0: 你好，欢迎使用语音识别功能
时间: 0.00s - 2.50s

句子 1: 这是一个测试音频
时间: 2.50s - 4.00s
```

## 🎨 界面特性

### 工具调用状态显示
- **🎤 语音识别**: 工具名称标识
- **加载动画**: 三个小点跳动动画
- **黄色背景**: 工具调用消息使用特殊样式
- **等宽字体**: 转录结果使用等宽字体显示

### 状态流转
1. **开始**: 显示"正在转录音频..."
2. **处理中**: 显示加载动画
3. **完成**: 显示转录结果，移除加载状态

## 🔧 技术实现

### 后端组件
- **`speech_tool.py`**: 语音识别工具实现
- **`agent.py`**: LangGraph Agent 图结构，支持工具调用
- **`main.py`**: WebSocket 消息协议扩展

### 前端组件
- **`ChatSidebar.tsx`**: 聊天界面，支持工具调用状态显示
- **消息类型**: 扩展 Message 接口支持工具调用信息

### 关键特性
- **异步处理**: 使用 Paraformer-V2 异步 API
- **错误处理**: 完善的错误处理和用户提示
- **流式输出**: 支持实时状态更新
- **JSON 格式**: 工具返回结构化数据供 LLM 处理

## 📝 使用示例

### 示例 1: 简单转录请求
```
用户: 请转录这个音频 https://example.com/meeting.wav

AI: 好的，我来为您转录这个音频文件。
[显示工具调用状态]
转录结果：
句子 0: 大家好，欢迎参加今天的会议
时间: 0.00s - 3.20s

句子 1: 我们今天主要讨论项目进度
时间: 3.20s - 6.80s
```

### 示例 2: 带问题的转录请求
```
用户: 这个音频里说了什么？https://example.com/speech.mp3

AI: 我来为您转录这个音频内容。
[显示工具调用状态]
根据转录结果，音频内容如下：

句子 0: 今天天气很好
时间: 0.00s - 2.50s

句子 1: 我们一起去公园吧
时间: 2.50s - 5.00s
```

## ⚠️ 注意事项

### 使用限制
1. **URL 访问**: 音频文件必须公网可访问
2. **文件大小**: 建议不超过 100MB
3. **处理时间**: 根据音频长度，处理时间可能较长
4. **网络依赖**: 需要稳定的网络连接

### 错误处理
- **无效 URL**: 显示"无法访问音频文件"错误
- **格式不支持**: 显示"音频格式不支持"错误
- **处理失败**: 显示"转录处理失败"错误
- **网络错误**: 显示"网络连接错误"错误

## 🚀 未来扩展

### 计划功能
1. **批量处理**: 支持多个音频文件同时转录
2. **语言检测**: 自动检测音频语言
3. **说话人识别**: 识别不同说话人
4. **关键词提取**: 从转录结果中提取关键词
5. **摘要生成**: 自动生成音频内容摘要

### 技术改进
1. **缓存机制**: 缓存转录结果避免重复处理
2. **进度显示**: 显示转录进度百分比
3. **断点续传**: 支持大文件分段处理
4. **质量评估**: 评估转录质量并给出建议

## 📞 技术支持

如果遇到问题，请检查：
1. 音频文件 URL 是否可以正常访问
2. 网络连接是否稳定
3. 音频格式是否支持
4. 文件大小是否过大

更多技术细节请参考源代码注释和 API 文档。
