<!-- 848aa42b-9a7d-4cbd-afd5-d931af7acf05 b6080b8a-b0cb-4669-91d7-025db67e7638 -->
# 添加反馈和订阅功能到操作记录栏

## 1. 环境变量配置

### 1.1 添加环境变量到 `chat-frontend/.env.local`

```env
NEXT_PUBLIC_AUTHOR_EMAIL=your-email@example.com
NEXT_PUBLIC_APP_GITHUB=https://github.com/your-repo/video2sop
```

## 2. 创建Modal组件

### 2.1 创建 `chat-frontend/src/components/Modal.tsx`

通用模态对话框组件，支持：

- 标题、内容、关闭按钮
- 自定义子组件渲染
- 点击遮罩层关闭
- ESC键关闭
```typescript
interface ModalProps {
  isOpen: boolean;
  onClose: () => void;
  title: string;
  children: React.ReactNode;
}
```


## 3. 创建反馈组件

### 3.1 创建 `chat-frontend/src/components/FeedbackModal.tsx`

反馈模态框，包含：

- 说明文字（从环境变量读取作者邮箱）
- 三个选项按钮：

  1. "下载会话内容（同意保留视频）" - 调用下载函数，标记视频保留
  2. "下载会话内容（不保留视频）" - 调用下载函数，不包含视频链接
  3. "仅提建议" - 关闭弹窗

### 3.2 实现会话报告生成函数

在 `chat-frontend/src/utils/sessionReport.ts` 创建：

- `generateSessionReport(options)` - 生成HTML报告
- 使用Tailwind CDN (`<script src="https://cdn.tailwindcss.com"></script>`)
- 包含内容：
  - 会话基本信息（时间、ID）
  - 视频/音频链接（可选）
  - 操作记录列表
  - 语音识别结果
  - 视频理解结果
  - SOP草稿和解析结果
  - 用户修改的提示词（如果有）

报告结构示例：

```html
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <script src="https://cdn.tailwindcss.com"></script>
  <title>Video2SOP 会话报告</title>
</head>
<body class="bg-gray-50">
  <div class="max-w-4xl mx-auto p-6">
    <h1 class="text-3xl font-bold mb-6">Video2SOP 会话报告</h1>
    <!-- 会话信息、操作记录等 -->
  </div>
</body>
</html>
```

### 3.3 实现下载功能

- 创建Blob对象
- 使用`URL.createObjectURL`生成下载链接
- 触发下载，文件名：`video2sop-session-${timestamp}.html`

## 4. 创建订阅组件

### 4.1 创建 `chat-frontend/src/components/SubscribeModal.tsx`

订阅模态框，包含：

- 说明文字
- 作者邮箱（从环境变量读取）
- GitHub仓库链接（从环境变量读取，可点击跳转）

## 5. 后端API支持

### 5.1 添加视频保留标记端点到 `langgraph-agent/main.py`

```python
@app.post("/mark_session_keep_video")
async def mark_session_keep_video(request: dict):
    """标记会话视频保留"""
    session_id = request.get("session_id")
    client_session_id = request.get("client_session_id")
    
    # 将session_id添加到保留列表
    # 可以使用文件存储或数据库
    keep_sessions.add(session_id)
    
    return {"success": True, "session_id": session_id}
```

### 5.2 修改清理逻辑

在文件清理函数中检查`keep_sessions`集合，跳过标记的会话

## 6. 更新OperationHistory组件

### 6.1 修改 `chat-frontend/src/components/OperationHistory.tsx`

在标题下方添加两行新按钮：

**第三行 - 反馈按钮：**

```tsx
<div className="mt-2">
  <button onClick={() => setShowFeedback(true)} 
          className="w-full px-3 py-1.5 bg-blue-500 text-white rounded text-sm hover:bg-blue-600">
    报告异常或提建议
  </button>
</div>
```

**第四行 - 订阅按钮：**

```tsx
<div className="mt-2">
  <button onClick={() => setShowSubscribe(true)}
          className="w-full px-3 py-1.5 bg-green-500 text-white rounded text-sm hover:bg-green-600">
    订阅功能更新通知
  </button>
</div>
```

### 6.2 添加必要的props

传入当前会话数据：

- `currentUploadResult` - 上传结果（视频/音频链接、session_id）
- `speechRecognitionResult` - 语音识别结果
- `videoUnderstandingResult` - 视频理解结果
- `sopBlocks` - SOP区块数据

## 7. 主页面集成

### 7.1 更新 `chat-frontend/src/app/page.tsx`

传递额外的props给OperationHistory：

```tsx
<OperationHistory 
  // ... 现有props
  currentUploadResult={currentUploadResult}
  speechRecognitionResult={speechRecognitionResult}
  videoUnderstandingResult={videoUnderstandingResult}
  clientSessionId={clientSessionId}
/>
```

## 实施顺序

1. 环境变量配置
2. 创建Modal基础组件
3. 实现会话报告生成工具
4. 创建FeedbackModal和SubscribeModal
5. 后端API添加视频保留标记
6. 更新OperationHistory组件
7. 主页面集成测试

### To-dos

- [ ] 创建视频理解工具模块 video_understanding_tool.py
- [ ] 在 main.py 添加 /video_understanding API端点
- [ ] 创建 VideoUnderstandingPanel.tsx 组件
- [ ] 安装前端 Markdown 渲染依赖
- [ ] 集成视频理解组件到主页面 page.tsx
- [ ] 测试完整工作流程：上传视频 → 语音识别 → 视频理解